# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

claude-task-manager is a TypeScript-based CLI tool/npm package that automates task management for Claude Code. It manages tasks through task.md files and enables efficient task execution through integration with Claude Code.

## Development Commands

### Build and Test
```bash
npm run build      # Compile TypeScript (output to dist/)
npm test          # Run Jest tests
npm run watch     # Watch files and auto-build
```

### CLI Execution in Development
```bash
npm run dev -- init                    # Initialize project
npm run dev -- new "Task name"         # Create new task
npm run dev -- run                     # Execute current task
npm run dev -- history                 # Show history
npm run dev -- status                  # Check status
npm run dev -- claude "prompt"         # Execute Claude Code directly
npm run dev -- lang                    # Check/change language
```

### Running Individual Tests
```bash
npm test -- TaskManager.test.ts        # Run specific test file
npm test -- --watch                    # Run tests in watch mode
```

## Architecture

### Directory Structure
- `src/bin/claude-task.ts`: CLI entry point. Defines CLI commands using commander
- `src/lib/TaskManager.ts`: Core business logic. Manages task creation, execution, and archiving
- `src/lib/i18n.ts`: Internationalization system supporting English and Japanese
- `src/types/index.ts`: TypeScript type definitions. Defines types like Task, TaskStatus, TaskPriority
- `src/locales/`: Language files (en.json, ja.json)
- `src/index.ts`: Entry point as npm package

### Key Design Patterns
1. **TaskManager class**: Central role in task management using singleton pattern
2. **task.md file**: Stores tasks in Markdown format. Directly readable by Claude Code
3. **Automatic archiving**: Old tasks are saved in `archive/` folder with timestamps
4. **Claude Code integration**: Directly calls Claude Code with `claude` command, including task.md content
5. **Custom commands**: Automatically generates `.claude/commands/task.md` when running `claude-task init`
6. **Internationalization**: Supports multiple languages (English/Japanese) with configurable language settings

### Important Implementation Details
- Uses TypeScript strict mode
- Abstracts file system operations with fs-extra
- Colors terminal output with chalk
- Standardizes date handling with date-fns
- Builds CLI commands with commander
- Implements i18n with custom localization system

## Claude Code Custom Commands

When you run `claude-task init`, a `/task` custom command is automatically created in the project's `.claude/commands/` directory. This enables the following commands within Claude Code:

- `/task new "task name"` - Create a new task
- `/task status` - Check current task status
- `/task run` - Execute current task (uses task.md content as context)
- `/task history` - Show task history
- `/task archive` - Archive completed task

Custom commands are generated by the `TaskManager.createClaudeCustomCommand()` method and operate independently for each project. The command templates are dynamically generated based on the current language setting.

## Testing Requirements

### **CRITICAL: Always Run Tests Before Committing**

**Never commit code without running tests. A task is NOT complete unless all tests pass.**

#### Before Every Commit:
1. Run all tests:
   ```bash
   npm test
   ```
2. If any test fails, fix the issue before proceeding
3. Run tests again to confirm the fix
4. Only commit when all tests pass

#### After Implementation:
1. Run specific test files related to your changes:
   ```bash
   npm test -- TaskManager.test.ts
   npm test -- run-command.test.ts
   ```
2. Run all tests to ensure no regressions:
   ```bash
   npm test
   ```
3. If tests fail, the implementation is NOT complete

#### Test-Driven Development:
- Write tests for new features before implementation
- Update existing tests when changing behavior
- Never skip or disable tests without proper justification

#### Common Test Issues:
- **i18n initialization**: Ensure i18n is initialized before using translations
- **File system operations**: Clean up test directories in afterEach
- **Async operations**: Always use async/await properly
- **Mock cleanup**: Reset mocks between tests

## Release Process

### **CRITICAL: Before Creating a Release Tag**

**Always update the following files before creating a tag:**

1. **package.json** - Update the version number
   ```json
   {
     "version": "1.0.5"
   }
   ```

2. **CHANGELOG.md** - Add entry for the new version
   ```markdown
   ## [1.0.5] - 2024-07-24
   
   ### Added
   - New features...
   
   ### Changed
   - Changes...
   
   ### Fixed
   - Bug fixes...
   ```

### Release Steps

1. Update version in package.json
2. Update CHANGELOG.md with all changes
3. Update README files if needed (README.md, README.ja.md)
4. Commit all changes
5. Push to main branch
6. Create and push tag:
   ```bash
   git tag v1.0.5
   git push origin v1.0.5
   ```

### Important Notes
- Tag version must match package.json version exactly
- Tag must be prefixed with 'v' (e.g., v1.0.5)
- GitHub Actions will automatically publish to npm when tag is pushed
- Once published to npm, versions cannot be unpublished